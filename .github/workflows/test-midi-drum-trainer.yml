name: MIDI Drum Trainer Automated Tests (Headless REAPER Build)

permissions:
  contents: read
  actions: write

on:
  workflow_dispatch:
  push:
    paths:
      - 'MIDI/ambrosebs_MIDI Drum Trainer.jsfx'
      - 'tests/test_midi_drum_trainer.lua'
      - '.github/workflows/test-midi-drum-trainer.yml'

env:
  REAPER_MAJOR_VERSION: "7"
  REAPER_MINOR_VERSION: "48"
  SWS_VERSION: "2.14.0.7"
  WDL_COMMIT: "3024ec8e000f769454b5ee4ac927dc5cecfc6a6b"

jobs:
  test-midi-drum-trainer:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libx11-dev libglib2.0-0 libgtk-3-0 xz-utils git cmake

      # - name: Cache WDL headless build
      #   id: cache_wdl
      #   uses: actions/cache@v4
      #   with:
      #     path: |
      #       ${{ github.workspace }}/wdl
      #     key: wdl-${{ env.WDL_COMMIT }}

      # Build WDL headless (always runs unless cache-hit is true, but cache step is commented out)
      - name: Build WDL headless
        # if: steps.cache_wdl.outputs.cache-hit != 'true'  # uncomment for cache use
        run: |
          git clone https://github.com/justinfrankel/WDL.git wdl
          cd wdl
          git checkout ${WDL_COMMIT}
          cd WDL/swell
          make NOGDK=1 -Wno-error
          echo "Listing all files under $(pwd) to search for libSwell.so:"
          find . -type f | tee /tmp/wdl-files.log
          echo "Directory tree under $(pwd):"
          find . | tee /tmp/wdl-tree.log

      - name: Prepare headless REAPER install
        run: |
          mkdir -p reaper/REAPER/UserPlugins
          # Download and extract official SWS
          wget -O sws.tar.xz "https://www.sws-extension.org/download/featured/sws-${SWS_VERSION}-Linux-x86_64.tar.xz"
          tar -xf sws.tar.xz
          cp UserPlugins/reaper_sws-x86_64.so reaper/REAPER/UserPlugins/
          # Download official REAPER binary
          wget -O reaper.tar.xz "https://www.reaper.fm/files/${REAPER_MAJOR_VERSION}.x/reaper${REAPER_MAJOR_VERSION}${REAPER_MINOR_VERSION}_linux_x86_64.tar.xz"
          tar -xf reaper.tar.xz
          mv reaper_linux_x86_64/reaper reaper/REAPER/reaper
          chmod +x reaper/REAPER/reaper
          # Locate libSwell.so from WDL build and copy to REAPER directory
          cp wdl/WDL/swell/libSwell.so reaper/REAPER/libSwell.so

      - name: Copy test script into REAPER scripts
        run: |
          mkdir -p reaper/REAPER/Scripts/tests
          cp tests/test_midi_drum_trainer.lua reaper/REAPER/Scripts/tests/

      - name: Install REAPER license
        run: |
          mkdir -p reaper/REAPER
          echo "${{ secrets.REAPER_LICENSE_KEY }}" > reaper/REAPER/license.txt

      # Combined step: start Xvfb, tail resource directory, run Hello World and main test scripts
      - name: Tail REAPER resource directory and run tests
        env:
          DISPLAY: ":99"
        run: |
          echo "Starting Xvfb for REAPER GUI..."
          Xvfb :99 &
          sleep 2

          echo "Tailing REAPER resource directory for live changes..."
          mkdir -p reaper/REAPER
          (find reaper/REAPER -type f | xargs -r tail -F 2>/dev/null | tee tail-resource.log &)

          echo "Creating Hello World Lua script..."
          echo 'reaper.ShowConsoleMsg("Hello World from GitHub Actions!\\n")' > reaper/REAPER/Scripts/tests/test_hello_world.lua

          echo "Starting REAPER Hello World test..."
          reaper/REAPER/reaper -nosplash -new -ignoreerrors -close:exit reaper/REAPER/Scripts/tests/test_hello_world.lua || true
          echo "Finished REAPER Hello World test."

          echo "Running MIDI Drum Trainer test script in REAPER..."
          reaper/REAPER/reaper -nosplash -new -ignoreerrors -close:exit reaper/REAPER/Scripts/tests/test_midi_drum_trainer.lua 2>&1 | tee reaper_test_output.log

      - name: Check test results and fail if any unit test fails
        run: |
          echo "========== MIDI Drum Trainer Test Results =========="
          cat reaper_test_output.log

          # Grep the summary and check for 'unit tests passed'
          summary=$(grep 'Summary:' reaper_test_output.log || true)
          echo "$summary"

          # Check for REAPER usage output (indicating script did not run)
          if grep -q "Usage: reaper" reaper_test_output.log; then
            echo "ERROR: REAPER printed usage instructions instead of running the script."
            exit 1
          fi

          # Fail if summary is empty (i.e., script did not run or did not output summary)
          if [[ -z "$summary" ]]; then
            echo "ERROR: No summary found in REAPER output. Script did not run or test results not printed."
            exit 1
          fi

          # Extract passed/total counts
          scenario_passed=$(echo "$summary" | sed -n 's/.* \([0-9]\+\)\/\([0-9]\+\) scenarios passed.*/\1/p')
          scenario_total=$(echo "$summary" | sed -n 's/.* \([0-9]\+\)\/\([0-9]\+\) scenarios passed.*/\2/p')
          test_passed=$(echo "$summary" | sed -n 's/.* \([0-9]\+\)\/\([0-9]\+\) unit tests passed.*/\1/p')
          test_total=$(echo "$summary" | sed -n 's/.* \([0-9]\+\)\/\([0-9]\+\) unit tests passed.*/\2/p')

          if [[ "$scenario_passed" != "$scenario_total" || "$test_passed" != "$test_total" ]]; then
            echo "ERROR: Not all scenarios or unit tests passed!"
            exit 1
          fi

          echo "All tests passed."

      - name: Upload REAPER test output log (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reaper-test-output
          path: reaper_test_output.log

      - name: Upload REAPER resource tail log (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reaper-resource-tail
          path: tail-resource.log
